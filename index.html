<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PWA in 2021</title>

    <meta name="description" content="A demo of what we can do with PWAs in 2021">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="manifest.webmanifest">

    <link rel="icon" sizes="192x192" href="/images/icon-192x192.png">

    <meta name="theme-color" content="#D33257">
    <meta property="og:title" content="PWA in 2021">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://cdsx2021.netlify.app/images/icon-192x192.png">
    <meta property="og:url" content="https://cdsx2021.netlify.app/">
    <meta property="og:description" content="A demo of what we can do with PWAs in 2021">

    <link rel="stylesheet" href="styles/reset.css">
    <link rel="stylesheet" href="styles/main.css">

  </head>
  <body>
    
    <main>
      <h1>PWA in 2021</h1>

      <button id="install" hidden>Install</button>

      <br><br>

      <button id="notification-permission">Request notifications permission</button>
      <button id="notification-send">Send notification</button>

      <br><br>

      <button id="background-fetch">Start a background fetch</button>
      <div id="background-fetch-progress"></div>
        
      
    </main>

    <script>
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).then((registration) => {
          console.log('Service Worker Registered');
        });

        navigator.serviceWorker.ready.then((registration) => {
          console.log('Service Worker Ready');
        });
      }

      const installButton = document.getElementById('install');

      let installPrompt;

      window.addEventListener('beforeinstallprompt', (event) => {
        event.preventDefault();
        installPrompt = event;
        installButton.removeAttribute('hidden');
      });

      installButton.addEventListener('click', async (event) => {
        installPrompt.prompt();
        const { outcome } = await installPrompt.userChoice;

        alert(outcome);

        console.log(outcome)

        if (outcome === "accepted" ) {
          installButton.setAttribute('hidden', 'hidden');
        }

      });

      window.addEventListener('appinstalled', (event) => {
        installButton.setAttribute('hidden', 'hidden');
      });



      // Notifications


      
      const notificationPermissionButton = document.getElementById('notification-permission');
      const notificationSendButton = document.getElementById('notification-send');

      if ('Notification' in window) {

        

        if (Notification.permission === "granted") {
          notificationPermissionButton.setAttribute('hidden', 'hidden');
        }


        notificationPermissionButton.addEventListener('click', () => {
          Notification.requestPermission();
        });

        notificationSendButton.addEventListener('click', () => {


          navigator.serviceWorker.ready.then(function(registration) {
            registration.showNotification(
              'Hello AEA!', 
              { body: 'How are you doing?', icon: '/images/icon-256.png' });
          });

        });


      } else {
        notificationPermissionButton.setAttribute('hidden', 'hidden');
        notificationSendButton.setAttribute('hidden', 'hidden');
      }



      // Background fetch

      document.getElementById('background-fetch').addEventListener('click', () => {
        
        navigator.serviceWorker.ready.then(async (registration) => {
            const videoFetch = await registration.backgroundFetch.fetch('video-fetch', ['/media/audio.mp4'], {
                title: 'Funny Video',
                icons: [{ sizes: '300x300', src: '/images/icon-256.png', type: 'image/png', }],
                downloadTotal: 60 * 1024 * 1024,
            });

            videoFetch.addEventListener('progress', () => {
                const percent = Math.round(videoFetch.downloaded / videoFetch.downloadTotal * 100);
                document.getElementById('background-fetch-progress').textContent = `Download progress: ${percent}%`;
            });
        });

      });

      


    </script>


  </body>
</html>